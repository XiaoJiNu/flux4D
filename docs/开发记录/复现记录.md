# Flux4D 复现记录

## 记录说明

- 参考 `docs/开发记录/复现计划.md` 执行，按阶段记录每次实际动作与结果。
- 调试阶段在 24G 5090 上保持论文视图数与分辨率，仅缩小 batch/启用梯度累积。

## 环境与目标

- 数据集：PandaSet（`/home/yr/yr/data/automonous/pandaset`）。
- 参考仓库：GaussianSTORM（`/home/yr/yr/code/cv/AutoLabel/SSL/GaussianSTORM_all/GaussianSTORM`，环境 `storm`）。
- 目标：复现 PSNR/SSIM/Depth RMSE，以及 Scene Flow 指标（EPE3D/Acc5/Acc10/θϵ/EPE-3way/分桶 EPE），并产出可视化结果。

## 进度总览

- 阶段0：环境与基线验证（已完成）
- 阶段1：数据索引与切片（已完成）
- 阶段2：Lift 初始化（已完成）
- 阶段3：Flux4D-base 预测器（已完成，tiny clip overfit 门禁通过）
- 阶段4：时间推进与光流渲染（已完成 v_r 门禁脚手架）
- 阶段5：Flux4D 增强（已跑通单帧 overfit，但细节偏糊，暂时暂停优化）
- 阶段6：全量训练与评测（已实现训练/评测脚手架，开始全量训练）

## 2026-01-27

### 已完成

- 创建顶层目录结构：`configs/`、`data/`、`src/flux4d/`、`scripts/`、`tools/vis/`、`tests/`、`assets/`、`third_party/`。
- 明确调试策略：保持论文视图数与分辨率，仅通过 batch 与梯度累积控制显存。
- 核对 PandaSet 时间同步与标定文件（样例：`001`）：`meta` 与 `lidar` timestamps 对齐，各相机 timestamps 与 lidar 长度一致且存在固定 offset；`intrinsics.json` 与 `poses.json` 完整。
- 在 `gaussianstorm` 环境复跑 GaussianSTORM demo，推理日志与视频输出正常（`work_dirs/inference_test/ckpt_099999_sky_affine/logs/log.txt` 与 `work_dirs/inference_test_outputs_sky_affine/test_*.mp4`）。
- 生成 PandaSet clip 索引：`data/metadata/pandaset_full_clips.pkl`（515 条）与
  `data/metadata/pandaset_tiny_clips.pkl`（10 条，默认场景 `001/002`，10Hz，1.5s，stride=1.5s；**用于调试**）。
  - 备注：论文/补充材料的训练与评测切分规则（11/16 帧、5 帧 overlap、每 20 帧采样评测 snippet、固定 test logs）尚未写入当前索引生成逻辑，后续需按 `docs/开发记录/复现计划.md` 对齐。
- 补充数据说明文档：`docs/数据处理与说明/数据处理与说明.md`。
- 按编码规范补齐中文 Docstring 与类型标注，新增 PKL 检查脚本 `scripts/inspect_pkl.py`。
- 新增 Lift 初始化模块与对齐可视化脚本：`src/flux4d/lift/lift_lidar.py`、`tools/vis/vis_lift_alignment.py`。
- 运行对齐可视化门禁：输出 `assets/vis/lift_alignment/rgb.png`、
  `assets/vis/lift_alignment/rgb_points.png`、`assets/vis/lift_alignment/depth_gray.png`。
- 运行最小单测：`python -m pytest -q tests/test_pandaset_clips.py tests/test_lift_lidar.py`。

### 待办

- 阶段3：实现稀疏 3D U-Net 预测器并完成 tiny clip 过拟合门禁。

### 问题与阻塞

- 暂无。

## 2026-01-29

### 动机

- 修复 PandaSet 的 epoch 秒时间戳在 `float32` 下精度不足导致 `Δt≈0` 的问题，避免后续时间推进/运动学习失效。
- 保持索引 PKL 的生成方式不变（按帧号切片），仅修复时间建模与可视化验证流程。

### 关键变更

- Lift 时间戳改为 clip 内 LiDAR **相对时间（秒）**（以当前 clip 起始 LiDAR 时间为 0）：
  `src/flux4d/lift/lift_lidar.py`（`build_initial_gaussians_for_clip`）。
- 补充数据说明文档中“时间戳与时间建模（以 LiDAR 为时间轴）”：
  `docs/数据处理与说明/数据处理与说明.md`。
- 扩展 Lift 对齐可视化脚本能力（支持随机采样帧、分层输出目录、可选保存 BEV 等），便于批量检查：
  `tools/vis/vis_lift_alignment.py`。

### 复现与可视化结果（seed=42）

- 重新生成 PKL：`make pandaset-index`（full=515, tiny=10）。
- 从 full 索引随机抽取 2 个 clip（seed=42）并对 `front_camera` 完整可视化 15 帧：
  - `clip_index=114`：`assets/vis/lift_alignment_seed42_full/clip_114_029_s060_e074/`
  - `clip_index=25`：`assets/vis/lift_alignment_seed42_full/clip_025_006_s000_e014/`

### 结论与下一步

- `t_rel` 能稳定表示 10Hz 的 0.1s 间隔，时间推进相关模块可继续推进；下一步进入阶段3（稀疏 3D U-Net 预测器）。

## 2026-01-30

### 动机

- 将阶段1/阶段2的关键实现细节与论文正文 + 补充材料对齐，减少后续阶段3训练闭环的口径偏差：
  - PandaSet 固定 test logs、11/16 帧切片与 5 帧 overlap、评测每 20 帧采样且每 log 4 个片段。
  - Lift 初始化：3-NN、随机四元数、opacity=0.5、timestamp 归一化到 [0,1]、sky 点采样规则。
- 明确复现坐标系契约（实现选择）：点云/渲染在 `world/log frame`，体素化输入在 `ego0`，速度语义输出到 `world`（静态背景≈0）。

### 关键变更

- 阶段1：索引生成支持 `paper` 预设（固定 test logs、front_camera、train_interpolation/train_future/eval_future 三类 setting）。
- 阶段1：索引 meta 写入坐标系口径（`lidar_points_frame=world`、`pose_convention=sensor_to_world`、`ego0_frame_index=0`）。
- 阶段2：Lift 初始化改为：
  - `k=3` 近邻尺度，scale 存储为 log 参数；
  - color/opacity 存储为 logit 参数（渲染前 sigmoid）；
  - timestamp 对每个 clip 做 min-max 归一化到 `[0,1]`；
  - 提供聚合版 `build_initial_gaussians_for_clip_aggregated`，并支持按补充材料采样 sky 点。
  - 增加 `max_gaussians` 随机下采样开关，避免调试时高斯数量过大。
- 阶段3：补充 `world→ego0` 的体素化检查输出 BEV 图，便于快速核对 `point_cloud_range` 覆盖范围。
- 工程可运行性：在 base Python（NumPy 2.x）下 pandas 可能与 ABI 不兼容，因此可视化/读取 `.pkl.gz` 点云时使用 `gaussianstorm` 环境的 Python。

### 验证

- 单测通过：`python -m pytest -q`。
- 生成索引：`make pandaset-index`（full=1714, tiny=22）。
- 检查索引：`python scripts/inspect_pkl.py --path data/metadata/pandaset_tiny_clips.pkl --clip-index 0`（meta 含 `coord` 字段）。

### 可视化结果（用于门禁）

- 阶段2：Lift 对齐可视化（使用 `gaussianstorm` 环境 Python）：
  - 命令：
    `.../envs/gaussianstorm/bin/python tools/vis/vis_lift_alignment.py --index-path data/metadata/pandaset_tiny_clips.pkl --clip-index 0 --frame-index 0 --camera front_camera --output-dir assets/vis/lift_alignment_stage2`
  - 输出：`assets/vis/lift_alignment_stage2/clip_000_001_eval_future_s000_e015/camera_front_camera/frame_000/`（含 `rgb_points_lift.png`、`depth_gray_lift.png` 等）。
- 阶段3：体素化 sanity check + BEV（使用 `gaussianstorm` 环境 Python）：
  - 命令：
    `.../envs/gaussianstorm/bin/python scripts/inspect_stage3_voxelization.py --config configs/flux4d.py --index-path data/metadata/pandaset_tiny_clips.pkl --clip-index 0 --num-sky-points 20000 --out-dir assets/vis/stage3_voxel_sanity/clip_000 --plot-window-m 400`
  - 输出：`assets/vis/stage3_voxel_sanity/clip_000/bev_xy.png`；统计中 `valid_ratio≈0.818`（clip 0，max_gaussians=300k）。

### 关键变更（阶段3启动）

- 新增阶段3核心模块：
  - `src/flux4d/models/gaussian_voxelizer.py`：实现 G_init+T 的体素化（NumPy/PyTorch），支持 mean pooling 与 point2voxel 映射，并可选构建 spconv `SparseConvTensor`。
  - `src/flux4d/models/flux4d_unet.py`：实现 spconv 后端的稀疏 3D U-Net（Conv3D + BN1d + LeakyReLU，skip concat）。
  - `src/flux4d/models/flux4d_model.py`：实现 Flux4D-base 封装（输出 `ΔG_ego0`、`V_ego0`），并新增坐标系封装输出 `V_world`（用于速度语义统一）。
- 新增通用坐标变换工具：`src/flux4d/utils/frames.py`（点/向量变换、SE(3) 求逆、frame transform 构建）。
- 扩展 numpy-only 检查脚本：`scripts/inspect_stage3_voxelization.py`（支持输出 BEV 图）。
- 新增最小单测：`tests/test_frames.py`。
- Makefile 支持 `PYTHON` 覆盖（例如在 `gaussianstorm` 环境下运行）。

### 验证（阶段3启动）

- 单测通过：`python -m pytest -q`。

### 下一步（阶段3）

- 接入 `gsplat` 渲染与损失（RGB/SSIM/Depth + `λ_vel`）以完成 tiny clip overfit 门禁（loss 下降、PSNR/SSIM 上升、速度范数趋稳）。

## 2026-02-02

### 动机

- 兑现阶段3门禁：把“模型→渲染→损失→反传”的训练闭环补齐，确保后续阶段4/5能在同一套渲染与损失接口上迭代。

### 关键变更

- 新增渲染封装（时间推进 + 参数激活 + gsplat 渲染）：
  - `src/flux4d/render/flux4d_renderer.py`
- 新增阶段3最小损失（RGB L1 / SSIM / Depth L1 / Velocity）：
  - `src/flux4d/losses/flux4d_losses.py`
- 新增阶段3 tiny overfit 训练脚手架（单 clip、单相机、可选 projected depth）：
  - `src/flux4d/engine/trainer.py`
  - `scripts/train_flux4d.py`
- 新增 checkpoint 保存与断点续训（用于避免训练中断导致门禁产物丢失）：
  - `src/flux4d/engine/checkpoint.py`
  - `src/flux4d/engine/trainer.py`（保存 `ckpt_step_*.pt` 与 `ckpt_last.pt`）
  - `scripts/train_flux4d.py`（新增 `--save-ckpt-every` 与 `--resume-from`）
- Lift 时间戳归一化口径补齐：支持“只用 input 帧生成 G_init，但用全 clip 帧做时间归一化”，避免 future setting 下 `t∈[0,1]` 失真：
  - `src/flux4d/lift/lift_lidar.py`

### 门禁结果（阶段3 tiny clip overfit）

- 输出目录：`assets/vis/stage3_overfit/`（被 `.gitignore` 忽略，仅作为本地回归材料）。
- 观察 `step_010000/pred_rgb.png` vs `step_010000/gt_rgb.png`：主体结构已基本对齐，远处仍略模糊（可接受，符合 tiny overfit 门禁预期）。
- `meta.json` 记录：`clip_id=001_eval_future_s000_e015`、`num_gaussians=200000`、`use_depth=true`。

### 补充：二次训练产物（run2）

- 输出目录：`assets/vis/stage3_overfit_run2/`（被 `.gitignore` 忽略，仅作为本地回归材料）。
- 权重保存：
  - 里程碑 checkpoint：`ckpt_step_001000.pt` … `ckpt_step_010000.pt`（每 1000 step 一份）。
  - 最新 checkpoint：`ckpt_last.pt -> ckpt_step_010000.pt`。
- 可视化回归：`step_010000/pred_rgb.png`、`step_010000/gt_rgb.png`、`step_010000/pred_depth.png`、`step_010000/gt_depth.png`。
- `meta.json` 记录：`clip_id=001_eval_future_s000_e015`、`num_gaussians=200000`、`use_depth=true`、`save_ckpt_every=1000`。

### 结论与下一步

- 阶段3门禁通过：训练闭环可稳定运行并产出可视化回归材料；后续实验可通过 checkpoint 断点续训。
- 下一步进入阶段4：时间推进与光流渲染（渲染 flow map + 动态区域重加权），并补齐评测指标与验证脚本。

### 阶段4启动：Rendered Velocity（v_r）门禁脚手架

#### 动机

- 阶段4的关键输出 `v_r`（image space rendered velocity）在论文/补充材料中用于动态重加权，但工程实现容易出现口径歧义（单位、`Δt`、相机是否随时间变化）。
- 先把 `v_r` 的定义与门禁标准写清楚，并落地一套可复用的可视化脚本，作为后续阶段4/5迭代的回归入口。

#### 关键变更

- 明确阶段4口径与门禁（固定相机 pose 强门禁 + 逐帧相机 pose 对齐检查）：
  - `docs/开发记录/复现计划.md`
- 渲染器新增 `v_r`（像素位移）渲染接口（解析 Jacobian + gsplat 属性渲染）：
  - `src/flux4d/render/flux4d_renderer.py`
- 配置新增 `render.rendered_velocity`（`clip_mag_px=10` 对齐补充材料 A.1）：
  - `configs/flux4d.py`
- 新增阶段4门禁可视化脚本（输出 fixed_pose/per_frame_pose 两套结果）：
  - `tools/vis/vis_flow.py`
- 新增 NumPy 单测（解析公式与有限差分在小 `Δt` 下对齐）：
  - `tests/test_rendered_velocity.py`

#### 运行命令（在 gaussianstorm 环境）

- `.../envs/gaussianstorm/bin/python tools/vis/vis_flow.py --ckpt assets/vis/stage3_overfit_run2/ckpt_last.pt --out-dir assets/vis/stage4_flow_sanity/clip_000 --mode both --render-frames 0-15 --frame-ref 0`
- 输出：

## 2026-02-04

### 动机

- 启动阶段6：补齐 PandaSet 跨场景全量训练与评测闭环（对齐论文切片设置与指标口径），确保“能训、能评、口径可复现”。
- 修复全量训练过程中暴露的工程性问题，避免出现“看似能跑但评测/缓存口径有坑”的隐性 bug：
  - LiftCache 落盘临时文件扩展名导致的 `FileNotFoundError`；
  - dynamic-only PSNR 的通道均值口径错误；
  - refine 迭代时 `retain_grad` 放置位置不当导致 `.grad=None`；
  - 点投影 `z<=0` 时的除零/NaN 警告。

### 关键变更

- 新增阶段6训练与评测入口：
  - `scripts/train_stage6.py`：全量训练入口。
  - `scripts/eval_stage6.py`：评测入口（NVS + Scene Flow）。
- 新增阶段6引擎与指标实现：
  - `src/flux4d/engine/stage6.py`：多 clip 训练、LiftCache、评测指标汇总与落盘。
  - `src/flux4d/datasets/pandaset_cuboids.py`：cuboids 读取与几何工具（dynamic mask / Scene Flow GT）。
  - `src/flux4d/metrics/scene_flow.py`：Scene Flow 伪 GT 与指标（EPE3D/Acc5/Acc10/θϵ/EPE-3way/分桶 nEPE）。
  - `src/flux4d/metrics/image_metrics.py`：PSNR/SSIM/Depth RMSE（full + dynamic）。
- 关键 bug 修复（训练口径相关）：
  - LiftCache `.npz.tmp` 写盘文件名问题修复，并兼容旧残留 `*.npz.tmp.npz` 自动恢复。
  - masked PSNR 与 unmasked 口径对齐（按像素×通道一起求均值；空 mask 显式报错）。
  - refine 迭代：将 `retain_grad` 放到 `apply_delta_g_to_gaussians` 之后，保证可取到梯度。
  - 投影：仅对 `z>0` 的点做除法/取整，避免除零与 NaN cast 警告刷屏。
- 文档与命令完善：
  - `docs/开发记录/复现计划.md`：补齐阶段6（PSNR 定义、运行入口、推荐命令）。
  - `README.md`、`Makefile`：补齐 stage6-train/stage6-eval 可复现命令。
- 新增/补齐单测（最小口径自检）：
  - `tests/test_stage6_lift_cache.py`：缓存落盘与遗留恢复。
  - `tests/test_image_metrics.py`：PSNR masked/unmasked 口径。
  - `tests/test_scene_flow_metrics.py`、`tests/test_pandaset_cuboids_geometry.py`：Scene Flow / cuboid 几何。

### 运行与阶段性结果

- 启动全量训练（5090 24G 调试）：
  - `python scripts/train_stage6.py --config configs/flux4d.py --index-path data/metadata/pandaset_full_clips.pkl --device cuda:0 --iters 30000 --output-dir assets/vis/stage6_train/run_001`
  - 训练日志已输出分项 loss：`total/rgb/ssim/depth/vel/psnr`（便于定位训练异常）。
- 当前仅完成“跑通与口径校验”；正式指标需在 A100 上完成 30k iters 并运行 `scripts/eval_stage6.py` 汇总。

### 结论与下一步

- 阶段6训练/评测闭环已落地，且关键口径 bug 已修复并由最小单测覆盖。
- 下一步：
  - 在 A100 上跑满 `30000` iters，并用 `scripts/eval_stage6.py` 产出 `metrics.json` 与可视化结果；
  - 如训练速度仍偏慢，优先从（1）LiftCache 预热/并行、（2）减少一次性 sky 点数、（3）评测频率与保存频率 控制 IO 开销入手优化。
  - `assets/vis/stage4_flow_sanity/clip_000/fixed_pose/`（门禁 A）
  - `assets/vis/stage4_flow_sanity/clip_000/per_frame_pose/`（门禁 B）

## 2026-02-03

### 动机

- 开始阶段5（Flux4D 完整增强）：把论文正文 3.4 + 补充材料 A.1/A.2/A.3 的三个关键增强落到代码中：
  - Iterative refinement（N=3，梯度反馈）
  - Velocity reweighting（基于 rendered velocity `v_r` 的像素级重加权）
  - Polynomial motion（默认 ℓ=1，常加速度）

### 关键变更

- 多项式运动推进：
  - `src/flux4d/render/flux4d_renderer.py` 新增 `apply_polynomial_motion(...)`（补充材料 A.1 Eq.(2)）。
- Rendered Velocity 支持多项式速度：
  - `src/flux4d/render/flux4d_renderer.py` 新增 `evaluate_polynomial_velocity_torch(...)`，并让 `render_rendered_velocity_map(...)` 增加 `t_target_norm` 参数（在 `t'` 处求瞬时速度 `v(t')` 再投影到图像平面）。
- Iterative refinement（r_θ）网络与残差应用：
  - `src/flux4d/models/flux4d_model.py` 新增 `Flux4DRefineModel` 与 `apply_delta_g_to_gaussians(...)`，输入为 `(G, T, ∇G)` 输出 `ΔG`（对齐补充材料 Algorithm 2 的接口口径）。
- 训练闭环支持阶段5开关（仍沿用 `scripts/train_flux4d.py`）：
  - `src/flux4d/engine/trainer.py`：
    - 当 `cfg['model']['iterative_refine']['enabled']=True` 时，按 `num_iters` 执行多轮 refinement，并保存包含 base+refine 的 checkpoint。
    - 当 `cfg['loss']['velocity_reweighting']['enabled']=True` 时，使用 `w = 1 + stopgrad(|v_r|)`（并裁剪到 `1+clip_mag_px`）对 `L_rgb` 做像素级增权。
    - 当 `cfg['model']['head']['motion']['poly_degree_l']>0` 时，时间推进从 `apply_linear_motion` 切换到 `apply_polynomial_motion`。
- 可视化脚本同步支持多项式运动与新接口：
  - `tools/vis/vis_flow.py` 支持 `poly_degree_l>0` 时的推进，并补齐 `render_rendered_velocity_map(..., t_target_norm=...)`。
- 配置新增阶段5相关开关（默认不影响阶段3）：
  - `configs/flux4d.py` 新增 `loss.velocity_reweighting`（enabled/alpha_threshold）。

### 设计取舍（重要）

- Iterative refinement 中，为避免“同一 forward 图多次 backward”导致的 `retain_graph` 开销与潜在报错，本实现对 `step>0` 的迭代会对 `G` 与 `V` 做 `detach`：
  - base 网络（f_θ）仅从 `step==0` 的 loss 得到梯度；
  - refinement 网络（r_θ）从 `step>0` 的 loss 得到梯度；
  - `∇G` 作为特征输入遵循“stop-gradient”的工程口径（对齐补充材料关于 detached gradients 的描述）。

### 下一步

- 阶段5优化暂缓：保留当前实现与回归脚手架，后续再集中排查影响清晰度的上限因素（见下节结论）。

### 阶段5 overfit 回归（单帧，结果不理想，暂停）

#### 训练设置

- 固定监督帧：训练时固定同一张 target 帧（避免多帧/动态目标导致的“平均化模糊”）。
- 日志落盘：训练日志同时写入 `output_dir/train.log`，便于复盘与对比实验。

#### 运行命令（示例）

- `python scripts/train_flux4d.py --config configs/flux4d.py --clip-index 0 --camera front_camera --device cuda:0 --output-dir assets/vis/stage5_overfit --fixed-target-frame 1`

#### 现象与结论

- 即使只 overfit 单帧，`pred_rgb` 在边缘（车体边界/路牌/建筑轮廓）仍然偏糊，未达到“像素级贴合”的预期。
- 结论：阶段5优化暂时暂停，先固化脚手架能力（固定帧/日志）并推进文档与版本管理；后续再集中排查影响清晰度的上限因素（高斯尺度约束、densify/split、渲染分辨率与相机/位姿口径等）。

## 2026-02-04

### 动机

- 完善阶段5训练闭环的工程脚手架（不讨论效果）：将动态重加权的权重图构造收敛到可复用函数，并补齐可选平滑；
  同时补齐断点续训的兼容路径（模型结构变化时仅加载模型权重），方便后续在 A100 上继续推进阶段6。

### 关键变更

- 动态重加权权重图封装 + 可选平滑：
  - `src/flux4d/losses/flux4d_losses.py` 新增 `build_dynamic_weight_map_from_flow(...)` 与 `gaussian_blur_2d(...)`。
  - `configs/flux4d.py` 为 `loss.velocity_reweighting` 增加 `blur_sigma/blur_window`。
- 训练闭环使用统一的 weight_map 构造，并输出调试产物：
  - `src/flux4d/engine/trainer.py` 使用 `build_dynamic_weight_map_from_flow(...)` 生成 `rgb_weight_map`，并在 `step_*/` 保存 `rgb_weight.png`；
    同时在 `meta.json` 记录 `blur_*` 与 `resume_optimizer`。
- 断点续训兼容模型结构变更：
  - `scripts/train_flux4d.py` 新增 `--resume-no-optim`（仅加载模型权重，不加载 optimizer/RNG state）。
  - `README.md` 补充该用法说明。

### 结论与下一步

- 阶段5（除 Algorithm 3 动态聚类外）的训练闭环功能已具备且工程可用；暂不在本阶段继续做“清晰度/细节”效果优化。
- 下一步进入阶段6：全量训练与评测（实现数据加载/采样策略与指标闭环）。

## 2026-02-06

### 动机

- 对阶段6训练产物 `assets/vis/stage6_train/run_001/ckpt_last.pt` 做一次完整评测，补齐当前模型的定量结果记录，作为后续 A100 正式实验的对照基线。

### 关键动作

- 在 `gaussianstorm` 环境运行阶段6评测：
  - `python scripts/eval_stage6.py --config configs/flux4d.py --index-path data/metadata/pandaset_full_clips.pkl --data-root /home/yr/yr/data/automonous/pandaset --device cuda:0 --ckpt assets/vis/stage6_train/run_001/ckpt_last.pt --out-dir assets/vis/stage6_eval/run_001_eval_20260206 --save-renders --save-max-clips 3`
- 评测口径：`split=test` 且 `setting=eval_future`，共 40 个 clip（10 个 test logs × 每 log 4 段）。
- 产物落盘：
  - 指标：`assets/vis/stage6_eval/run_001_eval_20260206/metrics.json`
  - 可视化：`assets/vis/stage6_eval/run_001_eval_20260206/renders/`（保存 3 个 clip）

### 结果摘要

- NVS（full，count=400）：
  - `PSNR=13.6474`、`SSIM=0.5572`、`Depth RMSE=11.0015m`
- NVS（dynamic，count=387）：
  - `PSNR=18.9278`、`SSIM=0.5069`、`Depth RMSE=9.6024m`（`std=9.8860`，波动较大）
- Scene Flow（count=240）：
  - `EPE3D=0.0830m`、`Acc5=0.7902`、`Acc10=0.8357`、`θϵ=1.0926rad`
  - `EPE-3way`: `BS=0.0693`、`FS=0.0205`、`FD=0.7179`
  - `3way` 样本数：`BS=743595`、`FS=23544`、`FD=14506`

### 问题分析（当前 run_001）

- 指标结构被静态背景主导：`BS` 点占比约 95%，`FD` 点占比约 1.86%，导致总体 `EPE3D` 对动态目标误差不敏感。
- 动态目标误差显著偏高：`FD EPE=0.7179m`，明显高于 `BS/FS`，是当前 Scene Flow 的主要短板。
- 动态区域指标稳定性不足：`dynamic` 计数低于 `full` 且 `Depth RMSE` 方差较大，说明部分帧动态区域有效像素较少。
- 训练后期进入平台：结合 `train.log`，约 `10k` 迭代后总体指标提升趋缓，`30k` 后增益有限。

### 结论与下一步

- 本次评测已形成阶段6可复现实验基线（run_001），后续优化以提升动态目标质量为主，不再以静态背景收益为主。
- 下一步优先做三组对照实验：
  - 开启 `iterative refine`（保持其余设置不变）
  - 开启多项式运动（`poly_degree_l=1`）
  - 提高动态区域训练权重（基于 `v_r` / dynamic mask）
- 在 A100 上复现实验时，沿用本次评测口径和落盘路径约定，对比 `FD EPE`、`θϵ` 与 future 帧质量变化。
