# Flux4D 复现记录

## 记录说明

- 参考 `docs/开发记录/复现计划.md` 执行，按阶段记录每次实际动作与结果。
- 调试阶段在 24G 5090 上保持论文视图数与分辨率，仅缩小 batch/启用梯度累积。

## 环境与目标

- 数据集：PandaSet（`/home/yr/yr/data/automonous/pandaset`）。
- 参考仓库：GaussianSTORM（`/home/yr/yr/code/cv/AutoLabel/SSL/GaussianSTORM_all/GaussianSTORM`，环境 `storm`）。
- 目标：复现 PSNR/SSIM/Depth RMSE/Flow EPE，并产出可视化结果。

## 进度总览

- 阶段0：环境与基线验证（已完成）
- 阶段1：数据索引与切片（已完成）
- 阶段2：Lift 初始化（已完成）
- 阶段3：Flux4D-base 预测器（未开始）
- 阶段4：时间推进与光流渲染（未开始）
- 阶段5：Flux4D 增强（未开始）
- 阶段6：全量训练与评测（未开始）

## 2026-01-27

### 已完成

- 创建顶层目录结构：`configs/`、`data/`、`src/flux4d/`、`scripts/`、`tools/vis/`、`tests/`、`assets/`、`third_party/`。
- 明确调试策略：保持论文视图数与分辨率，仅通过 batch 与梯度累积控制显存。
- 核对 PandaSet 时间同步与标定文件（样例：`001`）：`meta` 与 `lidar` timestamps 对齐，各相机 timestamps 与 lidar 长度一致且存在固定 offset；`intrinsics.json` 与 `poses.json` 完整。
- 在 `gaussianstorm` 环境复跑 GaussianSTORM demo，推理日志与视频输出正常（`work_dirs/inference_test/ckpt_099999_sky_affine/logs/log.txt` 与 `work_dirs/inference_test_outputs_sky_affine/test_*.mp4`）。
- 生成 PandaSet clip 索引：`data/metadata/pandaset_full_clips.pkl`（515 条）与
  `data/metadata/pandaset_tiny_clips.pkl`（10 条，默认场景 `001/002`，10Hz，1.5s/stride 1.5s）。
- 补充数据说明文档：`docs/数据处理与说明/数据处理与说明.md`。
- 按编码规范补齐中文 Docstring 与类型标注，新增 PKL 检查脚本 `scripts/inspect_pkl.py`。
- 新增 Lift 初始化模块与对齐可视化脚本：`src/flux4d/lift/lift_lidar.py`、`tools/vis/vis_lift_alignment.py`。
- 运行对齐可视化门禁：输出 `assets/vis/lift_alignment/rgb.png`、
  `assets/vis/lift_alignment/rgb_points.png`、`assets/vis/lift_alignment/depth_gray.png`。
- 运行最小单测：`python -m pytest -q tests/test_pandaset_clips.py tests/test_lift_lidar.py`。

### 待办

- 阶段3：实现稀疏 3D U-Net 预测器并完成 tiny clip 过拟合门禁。

### 问题与阻塞

- 暂无。

## 2026-01-29

### 动机

- 修复 PandaSet 的 epoch 秒时间戳在 `float32` 下精度不足导致 `Δt≈0` 的问题，避免后续时间推进/运动学习失效。
- 保持索引 PKL 的生成方式不变（按帧号切片），仅修复时间建模与可视化验证流程。

### 关键变更

- Lift 时间戳改为 clip 内 LiDAR **相对时间（秒）**（以当前 clip 起始 LiDAR 时间为 0）：
  `src/flux4d/lift/lift_lidar.py`（`build_initial_gaussians_for_clip`）。
- 补充数据说明文档中“时间戳与时间建模（以 LiDAR 为时间轴）”：
  `docs/数据处理与说明/数据处理与说明.md`。
- 扩展 Lift 对齐可视化脚本能力（支持随机采样帧、分层输出目录、可选保存 BEV 等），便于批量检查：
  `tools/vis/vis_lift_alignment.py`。

### 复现与可视化结果（seed=42）

- 重新生成 PKL：`make pandaset-index`（full=515, tiny=10）。
- 从 full 索引随机抽取 2 个 clip（seed=42）并对 `front_camera` 完整可视化 15 帧：
  - `clip_index=114`：`assets/vis/lift_alignment_seed42_full/clip_114_029_s060_e074/`
  - `clip_index=25`：`assets/vis/lift_alignment_seed42_full/clip_025_006_s000_e014/`

### 结论与下一步

- `t_rel` 能稳定表示 10Hz 的 0.1s 间隔，时间推进相关模块可继续推进；下一步进入阶段3（稀疏 3D U-Net 预测器）。
