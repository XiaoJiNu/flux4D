# PandaSet 数据处理与说明

## 数据位置与目录结构

- 本机数据根目录：`/home/yr/yr/data/automonous/pandaset`
- 每个场景是一个数字目录，例如 `001/`、`002/`。
- 关键子目录（以 `001` 为例）：
  - `001/lidar/`：点云帧（`00.pkl.gz`...）、`timestamps.json`、`poses.json`
  - `001/camera/<camera_name>/`：图像帧（`00.jpg`...）、`timestamps.json`、
    `poses.json`、`intrinsics.json`

注意：仓库内只保存索引文件，原始数据仍在上述外部路径，不复制进仓库。

## 索引文件（PKL）

阶段1生成两个索引文件：

- `data/metadata/pandaset_full_clips.pkl`
- `data/metadata/pandaset_tiny_clips.pkl`

说明：索引文件为本地生成产物，默认被 `.gitignore` 忽略，需要在本机重新生成。

PKL 结构为一个字典：

- `meta`：索引级元信息
  - `data_root`：PandaSet 根目录
  - `clip_len_s` / `stride_s`：片段长度与步长（秒）
  - `target_fps`：切片目标帧率（默认 10Hz）
  - `scene_ids`：参与构建的场景列表
  - `val_scenes`：验证场景列表（默认取排序后最后 10 个）
  - `total_clips`：clip 数量
  - `created_at`：生成时间（UTC）
- `clips`：clip 记录列表
  - 每条记录包含：
    - `clip_id` / `scene_id` / `split`
    - `fps` / `fps_actual`
    - `frame_start` / `frame_end` / `frame_ids`
    - `timestamps`：`lidar` 与 `camera`（逐帧）
    - `intrinsics`：每个相机的内参
    - `extrinsics`：`lidar` 与 `camera` 的 `poses.json`（位置 + 四元数）
    - `image_paths` / `lidar_paths`：相对 `data_root` 的路径
    - `views`：可见相机名称列表

## 生成命令

```bash
python scripts/preprocess_flux4d.py \
  --data-root /home/yr/yr/data/automonous/pandaset \
  --out-full data/metadata/pandaset_full_clips.pkl \
  --out-tiny data/metadata/pandaset_tiny_clips.pkl
```

常用可选项：

- `--clip-len-s 1.5 --stride-s 1.5`（论文设置）
- `--tiny-scenes 001,002` 或 `--tiny-num-scenes 2`
- `--val-scenes 010,020,...`（手动指定验证集）
- `--val-num-scenes 10`（默认验证集数量）
- `--target-fps 10`（目标帧率，设为 0 则使用实际推断）

Makefile 入口：

```bash
make pandaset-index
```

## 数据使用示例

```python
from flux4d.datasets.pandaset_clips import load_clip_index, load_clip

payload = load_clip_index("data/metadata/pandaset_tiny_clips.pkl")
first_clip = payload["clips"][0]
clip = load_clip(first_clip, data_root="/home/yr/yr/data/automonous/pandaset")

print(clip["clip_id"], clip["views"])
print("lidar[0]", clip["lidar_paths"][0])
print("front[0]", clip["image_paths"][clip["views"][0]][0])
```

## 训练/验证拆分说明

- 默认按场景 ID 排序后，取最后 10 个场景作为验证集，其余作为训练集。
- 如需与论文固定划分保持一致，建议显式传入 `--val-scenes`。
